# sparklend-monitoring
## Overview
This repo contains a set of Tenderly Web3 actions that are used to monitor contracts in the Spark ecosystem. Monitoring is used for informational alerts as well as critical alerts. Slack webhooks are used to send messages to the team Slack channel. PagerDuty is used for critical alerts, notifying the team of a potential critical incident.

## Summary of Tenderly Monitoring Actions

| Monitor                           | Trigger(s) and Config                                                                                                                                                                                                                                | Logic |
| --------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----- |
| `cleanTransactionRegistry`        | Runs every 100 blocks.<br><br>Active on mainnet and Gnosis.<br>`clean-transaction-registry-mainnet` `clean-transaction-registry-gnosis`                                                                                                              | Some of other monitorings have to keep track of transactions that were already process, to not process a transaction twice if there are multiple trigger events emmited in one transaction.<br>This action periodically cleans storage from stale transaction records |
| `getAllReservesAssetLiability`    | Runs every 5 blocks.<br><br>Active on mainnet for SparkLend and AAVE.<br>`monitor-asset-liabilities` `monitor-asset-liabilities-aave`                                                                                                                |       |
| `getAssetPriceDeviance`           | Runs every 10 blocks.<br><br>Active on mainnet for SparkLend oracle.<br>`monitor-oracle-price-deviance`                                                                                                                                              | Checks whether newest oracle prices of Sparklend assets match prices provided by an off-chain source.<br>Additionally monitors prices of pegged assets:<br> - off-chain sDAI <> oracle DAI<br> - off-chain wstETH <> oracle WETH<br> - off-chain rETH <> oracle WETH<br> - off-chain BTC <> oracle WBTC<br>When a price deviance is spotted, an alert is sent to `spark-alerts`|
| `getCapAutomatorUpdate`           | Runs on alerts.<br>Triggered by `UpdateSupplyCap` and `UpdateBorrowCap` emitted in CapAutomator.<br><br>Active on mainnet.<br>`monitor-cap-automator-cap-updates`                                                                                    | Reads the asset, the old and the new cap value from the trigger event and sends a proper notification to `spark-info` |
| `getConfigurationChangeAave`      | Runs on alerts.<br>Triggered events emitted in PoolConfigurator and `AssetSourceUpdated` emitted in AaveOracle<br><br>Active on mainnet for Aave.<br>`monitor-aave-config-changes`                                                                   | Parses all inputs of the trigger event and sends a message to `aave-alerts` |
| `getCurrentAggregators`           | Runs on alerts.<br>Triggered by `confirmAggregator` function called in sthETH-ETH and WBTC-BTC Chainlink Oracles<br><br>Active on mainnet.<br>`monitor-current-price-source-aggregators`                                                             | Whenever `confirmAggregator` is called on any of the tracked oracles (which means that the aggregator was changed),<br>sends a message to `spark-alerts` with addresses of up to date aggregators of tracked oracles. |
| `getDSRAuthOracleRefresh`         | Runs on `SetPotData` event emission on domain receivers for DSROracle.<br><br>Active on Arbitrum, Base and Optimism.<br>`monitor-dsr-auth-oracle-refresh-arbitrum` `monitor-dsr-auth-oracle-refresh-base` `monitor-dsr-auth-oracle-refresh-optimism` | Whenever `SetPotData` is emitted on any of the tracked DSRAuthOracles, sends a message with current pot data to `spark-alerts` |
| `getExecOnSparkProxy`             | Runs on alerts.<br>Triggered by `exec` function called on Spark SubProxy<br><br>Active on mainnet.<br>`monitor-exec-on-spark-proxy`                                                                                                                  | Whenever `exec` is called on Spark SubProxy, sends a minimalistic notification to `spark-alerts` |
| `getGnosisExecutorOperations`     | Runs on alerts.<br>Triggered by `queue` and `execute` functions called on Gnosis Governance Executor<br><br>Active on Gnosis.<br>`monitor-gnosis-bridge-executor`                                                                                    | When `queue` is called on Gnosis Governance Executor, sends a message with a spell address and execution time.<br>When `execute` is called sends a message with all executed spell addresses in this transaction.<br>These messages are sent to `spark-alerts`|
| `getHighGasTransaction`           | Runs on alerts.<br>Triggered by `FlashLoan`, `Supply`, `Borrow`, `Repay`, `Withdraw` and `LiquidationCall` emitted on Pool<br><br>Active on mainnet.<br>`monitor-high-transaction-gas`                                                               | Whenever a transaction interacting with a Spark pool uses more than 2.500.000 a notification is sent to `spark-high-gas` |
| `getKillSwitchOracleTrigger`      | Runs on alerts.<br>Triggered by `Trigger` event emitted on KillSwitchOracle<br><br>Active on mainnet.<br>`monitor-kill-switch-oracle-trigger`                                                                                                        | Whenever the KillSwitchOracle is triggered, sends a notification to `spark-alerts` |
| `getKillSwitchOraclesState`       | Runs every 5 blocks.<br><br>Active on mainnet.<br>`monitor-kill-switch-oracle`                                                                                                                                                                       | Monitors KillSwitchOracle and sends a notification to `spark-alerts` whenever the trigger should be called.<br>Does not execute any operations, just notifies, that there are oracles that return prices below the threshold. |
| `getLiftOnDSChief`                | Runs on alerts.<br>Triggered by `lift` function called on DSChief<br><br>Active on mainnet.<br>`monitor-lift-on-dschief`                                                                                                                             | Sends a notification with a current `hat`, whenever `lift` is called on DSChief. |
| `getLiquidationSparkLend`         | Runs on alerts.<br>Triggered by `LiquidationCall` event emitted on Pool<br><br>Active on mainnet and Gnosis.<br>`monitor-user-liquidations-sparklend` `monitor-user-liquidations-sparklend-gnosis`                                                   | Whenever a liquidation occurs in Sparklend, sends a notification to `spark-info` with all liquidation data. |
| `getMetaMorphoCapChange`          | Runs on alerts.<br>Triggered by `SetCap` emitted in DAI MetaMorpho Vault.<br><br>Active on mainnet.<br>`monitor-meta-morpho-cap-change`                                                                                                              | Whenever a new cap is set in the DAI MetaMorpho Vault, a notification is sent with a new cap and link to the market overview. |
| `getPotDsrDataSync`               | Runs every 5 blocks.<br><br>Active on mainnet.<br>`monitor-pot-dsr-data-sync`                                                                                                                                                                        | Monitors pot contract on mainnet and DSRAuthOracles on foreign domains. If there is a difference in the dsr value for longer than 30 minutes, sends a notification to `spark-alerts`.<br>The notification is repeated every 30 minutes if the difference is still present. |
| `getProtocolInteractionSparkLend` | Runs on alerts.<br>Triggered by `Supply`, `Borrow`, `Repay` and `Withdraw` emitted on Pool<br><br>Active on mainnet and Gnosis.<br>`monitor-protocol-interactions` `monitor-protocol-interactions-gnosis`                                            | Whenever funds are deposited, withdrawn, borrowed or repaid, sends a notification to `spark-info` with all the parameters of the interactions.<br>Notifies only about transactions of at least $5.000.000 worth of assets moved ($100.00 for Gnosis market and messages are sent to `spark-info-gnosis`)|
| `getSparklendArtChange`           | Runs on alert. Triggered by `exec` function called on D3MHub<br><br>Active on mainnet.<br>`monitor-sparklend-art-changes`                                                                                                                            | Sends a notification whenever the art is changed in the vat contract for sparklend ilk. |
| `getSpellsReadyToExecute`         | Runs every 5 blocks.<br><br>Active on Gnosis.<br>`monitor-not-executed-spells`                                                                                                                                                                       | Monitors Gnosis Governance executor and sends a notification if there is a spell awaiting to be executed for longer than 10 minutes |
| `getUserInfo`                     | Runs on alerts.<br>Triggered by `FlashLoan`, `Supply`, `Borrow`, `Repay`, `Withdraw` and `LiquidationCall` emitted on Pool<br><br>Active on mainnet for SparkLend and AAVE.<br>`monitor-user-health` `monitor-user-health-aave`                      |  |


***
*The IP in this repository was assigned to Mars SPC Limited in respect of the MarsOne SP*
